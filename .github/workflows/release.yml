name: Release

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:
    inputs:
      addon:
        description: 'Addon to release (leave empty for auto-detect)'
        required: false
        type: string

permissions:
  contents: write
  packages: write
  id-token: write   # Required for cosign OIDC signing

jobs:
  # Detect which addons changed and need releasing
  detect-changes:
    name: Detect addon changes
    runs-on: ubuntu-latest
    outputs:
      addons: ${{ steps.changes.outputs.addons }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Find changed addons
        id: changes
        run: |
          # Find all addon directories (have config.yaml with version)
          ADDONS=()

          for dir in */; do
            dir="${dir%/}"
            # Skip hidden dirs and common non-addon dirs
            [[ "$dir" == .* ]] && continue
            [[ "$dir" == "node_modules" ]] && continue

            if [ -f "$dir/config.yaml" ]; then
              # Check it has a version (confirms it's an addon)
              if grep -q "^version:" "$dir/config.yaml"; then
                VERSION=$(grep -E "^version:" "$dir/config.yaml" | sed 's/version: *"\?\([^"]*\)"\?/\1/')
                TAG="${dir}-v${VERSION}"

                # Check if this tag already exists
                if ! git rev-parse "$TAG" >/dev/null 2>&1; then
                  echo "âœ… New version detected: $dir v$VERSION"
                  ADDONS+=("{\"name\":\"$dir\",\"version\":\"$VERSION\"}")
                else
                  echo "â­ï¸  Tag $TAG already exists, skipping $dir"
                fi
              fi
            fi
          done

          # Output as JSON array
          if [ ${#ADDONS[@]} -eq 0 ]; then
            echo "addons=[]" >> $GITHUB_OUTPUT
            echo "No addons to release"
          else
            JSON=$(printf '%s\n' "${ADDONS[@]}" | jq -s -c '.')
            echo "addons=$JSON" >> $GITHUB_OUTPUT
            echo "Addons to release: $JSON"
          fi

  # Create releases for changed addons
  release:
    name: Release ${{ matrix.addon.name }}
    needs: detect-changes
    if: needs.detect-changes.outputs.addons != '[]'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        addon: ${{ fromJson(needs.detect-changes.outputs.addons) }}
    outputs:
      released: ${{ steps.create.outputs.released }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Get addon info
        id: info
        run: |
          ADDON="${{ matrix.addon.name }}"
          NAME=$(grep -E "^name:" "$ADDON/config.yaml" | sed 's/name: *"\?\([^"]*\)"\?/\1/')
          SLUG=$(grep -E "^slug:" "$ADDON/config.yaml" | sed 's/slug: *"\?\([^"]*\)"\?/\1/')
          DESC=$(grep -E "^description:" "$ADDON/config.yaml" | sed 's/description: *"\?\([^"]*\)"\?/\1/')

          echo "name=$NAME" >> $GITHUB_OUTPUT
          echo "slug=$SLUG" >> $GITHUB_OUTPUT
          echo "description=$DESC" >> $GITHUB_OUTPUT

      - name: Generate changelog
        run: |
          ADDON="${{ matrix.addon.name }}"
          VERSION="${{ matrix.addon.version }}"

          # Find previous tag for this addon
          PREV_TAG=$(git tag -l "${ADDON}-v*" --sort=-v:refname | head -1)

          {
            echo "## ${{ steps.info.outputs.name }} v${VERSION}"
            echo ""
            echo "${{ steps.info.outputs.description }}"
            echo ""
            echo "### Changes"
            echo ""

            if [ -n "$PREV_TAG" ]; then
              git log "$PREV_TAG"..HEAD --pretty=format:"- %s (%h)" -- "$ADDON/" || echo "- Various improvements"
            else
              echo "ðŸŽ‰ Initial release!"
              echo ""
              git log --pretty=format:"- %s (%h)" -- "$ADDON/" | head -15
            fi

            echo ""
            echo ""
            echo "### Installation"
            echo ""
            echo "Add this repository to Home Assistant:"
            echo ""
            echo "[![Add Repository](https://my.home-assistant.io/badges/supervisor_add_addon_repository.svg)](https://my.home-assistant.io/redirect/supervisor_add_addon_repository/?repository_url=https%3A%2F%2Fgithub.com%2F${{ github.repository_owner }}%2F${{ github.event.repository.name }})"
            echo ""
            echo "Or manually add: \`https://github.com/${{ github.repository }}\`"

            if [ -n "$PREV_TAG" ]; then
              echo ""
              echo "---"
              echo "**Full Changelog**: https://github.com/${{ github.repository }}/compare/${PREV_TAG}...${{ matrix.addon.name }}-v${{ matrix.addon.version }}"
            fi
          } > changelog.md

          cat changelog.md

      - name: Create Release
        id: create
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ matrix.addon.name }}-v${{ matrix.addon.version }}
          name: "${{ steps.info.outputs.name }} v${{ matrix.addon.version }}"
          body_path: changelog.md
          draft: false
          prerelease: false

      - name: Mark as released
        run: echo "released=true" >> $GITHUB_OUTPUT